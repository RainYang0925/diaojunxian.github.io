<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="方向"><title>持续集成实施(十七)——Fastlane总结 | 自动化测试</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">持续集成实施(十七)——Fastlane总结</h1><a id="logo" href="/.">自动化测试</a><p class="description">不二家的小球童的测试之路</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">持续集成实施(十七)——Fastlane总结</h1><div class="post-meta">Jan 20, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><h2 id="一、目标"><a href="#一、目标" class="headerlink" title="一、目标"></a>一、目标</h2><p>持续集成是一个不断迭代优化演进的过程，持续集成iOS打包，当前任务需要完成：</p>
<ul>
<li>内部测试版本：使用标准开发者的Developer证书签名的ipa文件。</li>
<li>公开测试版本：使用企业账户的Distribute InHouse证书签名的ipa文件。</li>
<li>AppStore版本：使用标准开发者的AppStore证书签名的ipa文件。</li>
<li>将打包结果推送公司Slack群</li>
<li>让测试和开发解耦开，测试随时自由打包<h2 id="二、初识"><a href="#二、初识" class="headerlink" title="二、初识"></a>二、初识</h2>一开始使用的是<code>xcodebuild</code>写的<code>shell</code>打包脚本，初次认识fastlane 的时候是去年的 10 月份，是老大开会提到了这样的以打包工具。仔细调研了一下，非常精细。它一个针对于 iOS 和 Android（后来才支持的）全方位自动化流程的工具套件。</li>
<li>deliver: Upload screenshots, metadata, and your app to the App Store</li>
<li>supply: Upload your Android app and its metadata to Google Play</li>
<li>snapshot: Automate taking localized screenshots of your iOS and tvOS apps on every device</li>
<li>screengrab: Automate taking localized screenshots of your Android app on every device</li>
<li>frameit: Quickly put your screenshots into the right device frames</li>
<li>pem: Automatically generate and renew your push notification profiles</li>
<li>sigh: Because you would rather spend your time building stuff than fighting provisioning</li>
<li>produce: Create new iOS apps on iTunes Connect and Dev Portal using the command line</li>
<li>cert: Automatically create and maintain iOS code signing certificates</li>
<li>spaceship: Ruby library to access the Apple Dev Center and iTunes Connect</li>
<li>pilot: The best way to manage your TestFlight testers and builds from your terminal</li>
<li>boarding: The easiest way to invite your TestFlight beta testers</li>
<li>gym: Building your iOS apps has never been easier</li>
<li>match: Easily sync your certificates and profiles across your team using Git</li>
<li>scan: The easiest way to run tests for your iOS and Mac apps<br>它可以集成打包，甚至上传AppStore和TestFlight，简直神器。<h3 id="三、使用Fastlane打包"><a href="#三、使用Fastlane打包" class="headerlink" title="三、使用Fastlane打包"></a>三、使用Fastlane打包</h3>下载fastlane，就三个命令：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo gem update --system</div><div class="line">sudo gem install bundler</div><div class="line">sudo gem install fastlane</div></pre></td></tr></table></figure>
<p>可以查看一下 <code>fastlane -v</code>的版本，我们打包主要用到<code>gym</code>和上传命令<code>pilot</code>，其他工具略有研究，但是未深入，还要提醒，我都是用的命令行格式，未使用官方推荐的Fastfile的方式，主要是我对ruby不够了解，因为我也是个大菜鸟。附上打包命令。</p>
<p>gym打包，需要讲解的不多，DEVELOPMENT_TEAM等等解释，可以详细看这里<a href="https://dpogue.ca/articles/cordova-xcode8.html" target="_blank" rel="external">https://dpogue.ca/articles/cordova-xcode8.html</a><br>需要提醒的是 xcpretty_report_josn可以输出<strong>oclint需要的xcpretty执行之后的内容，这里可以oclint集成到一起</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"></div><div class="line">#计时</div><div class="line">SECONDS=0</div><div class="line"></div><div class="line">#假设脚本放置在与项目相同的路径下</div><div class="line">project_path=$(pwd)</div><div class="line">#取当前时间字符串添加到文件结尾</div><div class="line">now=$(date +&quot;%Y_%m_%d_%H_%M&quot;)</div><div class="line">#取替换BundleVersion的时间字符串</div><div class="line">now_date=$(date +&quot;%Y%m%d%H%M&quot;)</div><div class="line">#获取当前脚本路径</div><div class="line">file_path=$(cd `dirname $0`; pwd)</div><div class="line"></div><div class="line">#指定项目的scheme名称</div><div class="line">scheme=&quot;MiFit&quot;</div><div class="line">#指定要打包的配置名</div><div class="line">configuration=&quot;Release&quot;</div><div class="line">#指定打包所使用的输出方式，目前支持app-store, package, ad-hoc, </div><div class="line">enterprise, development, 和developer-id，即xcodebuild的method</div><div class="line">参数</div><div class="line">export_method=&quot;app-store&quot;</div><div class="line"></div><div class="line">#指定项目地址</div><div class="line">workspace_path=&quot;xx&quot;</div><div class="line">#指定输出路径</div><div class="line">output_path=&quot;$project_path/APP/$&#123;now&#125;_out&quot;</div><div class="line">#指定输出归档文件地址</div><div class="line">archive_path=&quot;xx&quot;</div><div class="line">#指定输出ipa地址</div><div class="line">ipa_path=&quot;$output_path/&quot;</div><div class="line">#指定输出ipa名称</div><div class="line">ipa_name=&quot;xx&quot;</div><div class="line">#指定image和ipa最后路径</div><div class="line">image_path=&quot;$project_path/APP/image_out/&quot;</div><div class="line">#工程内infoplist</div><div class="line">project_infoplist_path=&quot;$&#123;project_path&#125;/xx/Info.plist</div><div class="line">#bundleIdentifier</div><div class="line">bundle_id=&quot;xx&quot;</div><div class="line">#证书名称</div><div class="line">rightDistributionSign=&quot;xx&quot;</div><div class="line"></div><div class="line">#手动证书管理方式</div><div class="line">sed -i &apos;&apos; &apos;s/ProvisioningStyle = Automatic;/</div><div class="line">ProvisioningStyle = Manual;/g&apos; &quot;$project_path/</div><div class="line">MiFit.xcodeproj/project.pbxproj&quot;</div><div class="line"></div><div class="line">#development_team名称</div><div class="line">DEVELOPMENT_TEAM=&quot;xx&quot;</div><div class="line">#PROVISIONING_PROFILE_SPECIFIER名称</div><div class="line">PROVISIONING_PROFILE_SPECIFIER=&quot;xx&quot;</div><div class="line"></div><div class="line">#ExoptionPlist地址</div><div class="line">ExoptionPlist=&quot;$&#123;file_path&#125;/Mifit-appstore.plist&quot;</div><div class="line"></div><div class="line">#修改info_plist中BundleVersion</div><div class="line">bundleBuildVersion=$(/usr/libexec/PlistBuddy -c &quot;print</div><div class="line"> CFBundleVersion&quot; &quot;$&#123;project_infoplist_path&#125;&quot;)</div><div class="line">if [ &quot;$&#123;bundleBuildVersion&#125;&quot; != &quot;$&#123;now_date&#125;&quot; ]; then</div><div class="line">	/usr/libexec/PlistBuddy -c &quot;set CFBundleVersion</div><div class="line">	$&#123;now_date&#125;&quot; $&#123;project_infoplist_path&#125;</div><div class="line">fi;</div><div class="line"></div><div class="line">#修改info_plist中BundleShortVersion,由于上传appstore对此有严格要求,故在不传入bundleShortVersion时，自动修正</div><div class="line">bundleShortVersion=$(/usr/libexec/PlistBuddy -c &quot;print </div><div class="line">CFBundleShortVersionString&quot; $&#123;project_infoplist_path&#125;)</div><div class="line">build_version=$1</div><div class="line">if [ $1 != &quot;&quot; ]; then</div><div class="line">	/usr/libexec/PlistBuddy -c &quot;set CFBundleShortVersionString </div><div class="line">	$&#123;build_version&#125;&quot; $&#123;project_infoplist_path&#125;</div><div class="line">else</div><div class="line">	arr=($&#123;bundleShortVersion//./ &#125;)</div><div class="line">	if [ &quot;$&#123;#arr[@]&#125;&quot; -gt 3 ] ; then</div><div class="line">	    bundleShortVersion=$&#123;arr[0]&#125;&quot;.&quot;$&#123;arr[1]&#125;&quot;.&quot;$(($</div><div class="line">	    &#123;arr[2]&#125;+1))</div><div class="line">	elif [ &quot;$&#123;#arr[@]&#125;&quot; -eq 3 ] ; then</div><div class="line">		bundleShortVersion=$&#123;bundleShortVersion&#125;</div><div class="line">	else</div><div class="line">	    bundleShortVersion=$&#123;bundleShortVersion&#125;&quot;.1&quot;</div><div class="line">	fi;</div><div class="line">	/usr/libexec/PlistBuddy -c &quot;set CFBundleShortVersionString </div><div class="line">	$&#123;bundleShortVersion&#125;&quot; $&#123;project_infoplist_path&#125;</div><div class="line">fi;</div><div class="line"></div><div class="line">#修改info_plist中bundleid</div><div class="line">bundleIdentifier=$(/usr/libexec/PlistBuddy -c &quot;print CFBundleIdentifier&quot; $&#123;project_infoplist_path&#125;)</div><div class="line">if [ &quot;$&#123;bundleIdentifier&#125;&quot; != &quot;\$(PRODUCT_BUNDLE_IDENTIFIER)&quot; ]; then</div><div class="line">	if [ &quot;$&#123;bundleIdentifier&#125;&quot; != &quot;$&#123;bundle_id&#125;&quot; ]; then</div><div class="line">		/usr/libexec/PlistBuddy -c &quot;set CFBundleIdentifier </div><div class="line">		$&#123;bundle_id&#125;&quot; $&#123;project_infoplist_path&#125;</div><div class="line">	fi;</div><div class="line">fi;</div><div class="line">#获取执行命令时的commit message</div><div class="line">commit_msg=&quot;$1&quot;</div><div class="line">#输出设定的变量值</div><div class="line">echo &quot;===workspace path: $&#123;workspace_path&#125;===&quot;</div><div class="line">echo &quot;===archive path: $&#123;archive_path&#125;===&quot;</div><div class="line">echo &quot;===build version: $&#123;build_version&#125;===&quot;</div><div class="line">echo &quot;===ipa path: $&#123;ipa_path&#125;===&quot;</div><div class="line">echo &quot;===ipa name: $&#123;ipa_name&#125;===&quot;</div><div class="line">echo &quot;===export method: $&#123;export_method&#125;===&quot;</div><div class="line">echo &quot;===commit msg: $1===&quot;</div><div class="line"></div><div class="line">#先清空前一次build</div><div class="line">rm -rf ~/Library/Developer/Xcode/DerivedData/*</div><div class="line">PROVISIONING_PROFILE_SPECIFIER=&quot;&#123;PROVISIONING_PROFILE_SPECIF</div><div class="line">IER&#125;&quot; </div><div class="line">fastlane gym</div><div class="line">--workspace $&#123;workspace_path&#125; </div><div class="line">--scheme $&#123;scheme&#125; </div><div class="line">--clean true </div><div class="line">--configuration $&#123;configuration&#125; </div><div class="line">--xcargs </div><div class="line">&quot;PRODUCT_BUNDLE_IDENTIFIER=&apos;$&#123;bundle_id&#125;&apos; </div><div class="line">DEVELOPMENT_TEAM=&apos;$&#123;DEVELOPMENT_TEAM&#125;&apos;&quot; </div><div class="line">--export_method $&#123;export_method&#125; </div><div class="line">--archive_path $&#123;archive_path&#125; </div><div class="line">--codesigning_identity &quot;$&#123;rightDistributionSign&#125;&quot; </div><div class="line">--export_options $&#123;ExoptionPlist&#125; </div><div class="line">--output_directory $&#123;ipa_path&#125;</div><div class="line">--output_name $&#123;ipa_name&#125; || exit</div><div class="line">#复制ipa到指定最后路径</div><div class="line">if [ ! -d &quot;$&#123;image_path&#125;&quot; ]; then</div><div class="line">  mkdir -p $&#123;image_path&#125;</div><div class="line">fi</div><div class="line">rm -rf &quot;$&#123;image_path&#125;MiFit.ipa&quot;</div><div class="line">rm -rf &quot;$&#123;image_path&#125;MiFit.app.dSYM.zip&quot;</div><div class="line">\cp -fr &quot;$&#123;ipa_path&#125;$&#123;ipa_name&#125;&quot; &quot;$&#123;image_path&#125;&quot;</div><div class="line">\cp -fr &quot;$&#123;ipa_path&#125;MiFit.app.dSYM.zip&quot; &quot;$&#123;image_path&#125;&quot;</div><div class="line"></div><div class="line">#输出总用时</div><div class="line">echo &quot;===Finished. Total time: $&#123;SECONDS&#125;s===&quot;</div></pre></td></tr></table></figure>
<h3 id="四、集成推送Slack"><a href="#四、集成推送Slack" class="headerlink" title="四、集成推送Slack"></a>四、集成推送Slack</h3><p>讲讲其他遇到的坑和解决方案。<br>由于主要使用fastlane中gym打包，但是这次需要注意的我们的需求是:</p>
<ul>
<li>需要分别打inhouse，adhoc，appstore的包</li>
<li>inhouse和adhoc作为内测，需要更换显示图标，加上内测字样。</li>
<li>inhouse包需要上传蒲公英（之前选择的Fir因为部分收费要求放弃了），需要跟slack对接，并且自动推送。</li>
</ul>
<hr>
<h5 id="1、分别打三种包，对证书和rightProvision了解的不够透彻？"><a href="#1、分别打三种包，对证书和rightProvision了解的不够透彻？" class="headerlink" title="1、分别打三种包，对证书和rightProvision了解的不够透彻？"></a>1、分别打三种包，对证书和<code>rightProvision</code>了解的不够透彻？</h5><p>解决：把三种证书都从开发那里要过来，然后将自己的APPLE ID升级到开发者<code>Admin</code>状态，就具有了三种证书的使用权限，然后跟开发一一对接，对每个包分别对应的证书了解并整理，打包的时候一一对应上就好。这个过程中，收获的是对xcodebuild的method参数有更深的了解，其实inhouse，adhoce，appstore分别对应的打包方式是<code>enterprise</code>，<code>ad-hoc</code>，<code>app-store</code>。</p>
<h5 id="2、需要更换inhouse的图标？"><a href="#2、需要更换inhouse的图标？" class="headerlink" title="2、需要更换inhouse的图标？"></a>2、需要更换inhouse的图标？</h5><p>解决：之前想通过是打包的时候指向不同的<code>target</code>，后来的解决方案是直接替换。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">for file in os.listdir(appIconPath):</div><div class="line">    if &quot;.png&quot; in file:</div><div class="line">        for appicon in os.listdir(replaceAppIconPath):</div><div class="line">            if file == appicon:</div><div class="line">                shutil.copy(replaceAppIconPath+&apos;/&apos;+appicon, </div><div class="line">                appIconPath+&apos;/&apos;+file)</div></pre></td></tr></table></figure>
<p>但是需要注意的是像素和尺寸需要保持一致，设计同学的帮忙很必要。</p>
<h5 id="3、和slack对接"><a href="#3、和slack对接" class="headerlink" title="3、和slack对接"></a>3、和slack对接</h5><p>解决：其实我觉得slack真的非常好用，因为它提供了各种整合持续集成的api，这里特别佩服我们老大对这块内容的重视，slack和jenkins集成非常方便。<br>只是网速有点不靠谱。slack api地址:<code>https://api.slack.com/docs/message-guidelines</code><br>附上我写的脚本，借助slack web api推送信息到slack，并且可以取出jenkins中执行者的信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line">#coding=utf-8</div><div class="line">import sys</div><div class="line">import time</div><div class="line">import requests</div><div class="line">import re</div><div class="line">from slacker import Slacker</div><div class="line"></div><div class="line">def send(job_url, job_name, starters, build_timestamp, </div><div class="line">workspace, build_cause, git_branch, change_log, text, </div><div class="line">userid):</div><div class="line">    &quot;&quot;&quot;执行结果推送slack，可选个人和channel&quot;&quot;&quot;</div><div class="line">    api_token = &quot;xxxx&quot;</div><div class="line">    slack = Slacker(api_token, 100)</div><div class="line">    data = [&#123;</div><div class="line">        &quot;fallback&quot;: &quot;Required plain-text summary of the </div><div class="line">        attachment.&quot;,</div><div class="line">        &quot;color&quot;: &quot;#36a64f&quot;,</div><div class="line">        &quot;fields&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;title&quot;: &quot;Job name&quot;,</div><div class="line">                &quot;value&quot;: job_name,</div><div class="line">                &quot;short&quot;: True</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;title&quot;: &quot;Build Trigger&quot;,</div><div class="line">                &quot;value&quot;: starters,</div><div class="line">                &quot;short&quot;: True</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;title&quot;: &quot;Build Time&quot;,</div><div class="line">                &quot;value&quot;: build_timestamp,</div><div class="line">                &quot;short&quot;: True</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;title&quot;: &quot;Build Workspace&quot;,</div><div class="line">                &quot;value&quot;: workspace,</div><div class="line">                &quot;short&quot;: True</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;title&quot;: &quot;Root Build Cause&quot;,</div><div class="line">                &quot;value&quot;: build_cause,</div><div class="line">                &quot;short&quot;: True</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;title&quot;: &quot;GIT_BRANCH&quot;,</div><div class="line">                &quot;value&quot;: git_branch,</div><div class="line">                &quot;short&quot;: True</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;title&quot;: &quot;Job url&quot;,</div><div class="line">                &quot;value&quot;: job_url,</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;title&quot;: &quot;CHANGE_LOG&quot;,</div><div class="line">                &quot;value&quot;: change_log,</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        ],</div><div class="line">        &quot;footer&quot;: &quot;XX公司&quot;,</div><div class="line">        &quot;ts&quot;: time.time()</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">    try_times = 0</div><div class="line">    while try_times &lt; 5:</div><div class="line">        try:</div><div class="line">            slack.chat.post_message(userid, text=text, </div><div class="line">        attachments=data)</div><div class="line">            return &quot;push to slack failed&quot;</div><div class="line">        except Exception as e:</div><div class="line">            time.sleep(50)</div><div class="line">            try_times += 1</div><div class="line">        if try_times &gt;= 5:</div><div class="line">            raise Exception(&apos;push to slack failed&apos;)</div><div class="line"></div><div class="line">def get_content(job_url):</div><div class="line">    &quot;&quot;&quot;取出console log全部内容&quot;&quot;&quot;</div><div class="line">    url = job_url + &quot;consoleText/api/json&quot;</div><div class="line">    headers = &#123;</div><div class="line">    	&quot;Content-Type&quot;: &quot;application/json&quot;,</div><div class="line">    	&quot;Accept&quot;: &quot;application/json&quot;</div><div class="line">    &#125;</div><div class="line">    response = requests.get(url, auth=(&quot;xx&quot;, &quot;xx&quot;))</div><div class="line">    assert response.status_code == requests.codes.ok</div><div class="line">    return response.content</div><div class="line"></div><div class="line">def get_trigger(result):</div><div class="line">    &quot;&quot;&quot;取出构建者&quot;&quot;&quot;</div><div class="line">    trigger_user = re.findall(r&quot;Started by&quot;, result)</div><div class="line">    trigger_other = re.findall(r&quot;Triggered by&quot;, result)</div><div class="line">    starters = &quot;&quot;</div><div class="line">    if len(trigger_user) &gt; 0:</div><div class="line">        starters = re.findall(r&quot;Started by(.*)&quot;, result)</div><div class="line">        [0].lstrip()</div><div class="line">    elif len(trigger_other) &gt; 0:</div><div class="line">        starters = re.findall(r&quot;Triggered by(.*)&quot;, result)</div><div class="line">ers = re[0].lstrip()</div><div class="line">    return starters</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    if len(sys.argv) &gt;= 2:</div><div class="line">        job_url = sys.argv[1]</div><div class="line">        job_name = sys.argv[2]</div><div class="line">        build_timestamp = sys.argv[3]</div><div class="line">        workspace = sys.argv[4] </div><div class="line">        build_cause = sys.argv[5]</div><div class="line">        git_branch = sys.argv[6]</div><div class="line">        text = sys.argv[7]</div><div class="line">        userid = sys.argv[8]</div><div class="line">        change_log = sys.argv[9]</div><div class="line">        result = get_content(job_url)</div><div class="line">        starters = get_trigger(result)</div><div class="line">        result = get_content(job_url)</div><div class="line">        starters = get_trigger(result)</div><div class="line">        send_userid = [&quot;#xx&quot;, userid]</div><div class="line">        for i in send_userid:</div><div class="line">            send(job_url, job_name, starters, end(job_url,build_timestamp, workspace, build_cause, git_branch, </div><div class="line">            change_log, text, i)</div></pre></td></tr></table></figure>
<p>然后构造请求，发送即可，详细不表。</p>
<h5 id="4、因为我们app两个平台用的xcode版本不一致，需要升级到xcode8，需要将自动管理改为手动管理证书。"><a href="#4、因为我们app两个平台用的xcode版本不一致，需要升级到xcode8，需要将自动管理改为手动管理证书。" class="headerlink" title="4、因为我们app两个平台用的xcode版本不一致，需要升级到xcode8，需要将自动管理改为手动管理证书。"></a>4、因为我们app两个平台用的xcode版本不一致，需要升级到xcode8，需要将自动管理改为手动管理证书。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i &apos;&apos; &apos;s/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g&apos; </div><div class="line">&quot;$project_path/project.pbxproj&quot;</div></pre></td></tr></table></figure>
<h5 id="5、pod-install总是出现问题，分析可能是因为网络或者本机pod安装有问题。"><a href="#5、pod-install总是出现问题，分析可能是因为网络或者本机pod安装有问题。" class="headerlink" title="5、pod install总是出现问题，分析可能是因为网络或者本机pod安装有问题。"></a>5、pod install总是出现问题，分析可能是因为网络或者本机pod安装有问题。</h5><p>若是pod问题，可以通过升级gem解决。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo gem update --system</div><div class="line">sudo gem install -n /usr/local/bin cocoapods</div></pre></td></tr></table></figure>
<blockquote>
<p>小贴士：谨慎使用sudo gem update</p>
</blockquote>
<h5 id="6、结果展示"><a href="#6、结果展示" class="headerlink" title="6、结果展示"></a>6、结果展示</h5><p>这是我们已经落地的工程，送上Slack推送截图。<img src="https://raw.githubusercontent.com/diaojunxian/diaojunxian.github.io/master/images/fastlane00.png" alt="Slack截图"></p>
<h3 id="五、集成推送TestFlight"><a href="#五、集成推送TestFlight" class="headerlink" title="五、集成推送TestFlight"></a>五、集成推送TestFlight</h3><p>Testflight当前已经被苹果公司收购并完善了功能，可以分发内测，作为提升app质量有很好的推动作用。推送TestFlight主要借助<code>fastlane pilot</code><br>看到pilot是最好的方式管理你的TestFlight 测试人员和从终端构建的工具。</p>
<blockquote>
<p>小贴士：上传TestFlight的ipa必须打包方式是appstore，且版本号应该为3位并高于已经在线上Appstore可以下载的版本。</p>
</blockquote>
<h5 id="1、上传脚本"><a href="#1、上传脚本" class="headerlink" title="1、上传脚本"></a>1、上传脚本</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">set -x</div><div class="line">#计时</div><div class="line">SECONDS=0</div><div class="line"></div><div class="line">#假设脚本放置在与项目相同的路径下</div><div class="line">project_path=$(pwd)</div><div class="line">#取当前时间字符串添加到文件结尾</div><div class="line">now=$(date +&quot;%Y_%m_%d_%H_%M&quot;)</div><div class="line">#取替换BundleVersion的时间字符串</div><div class="line">now_date=$(date +&quot;%Y%m%d%H%M&quot;)</div><div class="line">#获取当前脚本路径</div><div class="line">file_path=$(cd `dirname $0`; pwd)</div><div class="line"></div><div class="line">#上传用户的username</div><div class="line">username=&quot;xx&quot;</div><div class="line">#上传用户App id</div><div class="line">apple_id=&quot;xx&quot;</div><div class="line">#bundleIdentifier</div><div class="line">bundle_id=&quot;xxx&quot;</div><div class="line">#指定image和ipa最后路径</div><div class="line">ipa_path=&quot;$project_path/xx.ipa&quot;</div><div class="line">#上传team_id</div><div class="line">team_id=&quot;xxxx&quot;</div><div class="line">#上传team_name</div><div class="line">team_name=&quot;xxx&quot;</div><div class="line">#上传dev_portal_team_id</div><div class="line">dev_portal_team_id=&quot;xxx&quot;</div><div class="line">#上传itc_provider</div><div class="line">itc_provider=&quot;xxx&quot;</div><div class="line">distribute_external=$1</div><div class="line">changelog=&quot;xxxx&quot;</div><div class="line">beta_app_description=&quot;xxxx&quot;</div><div class="line">#反馈邮箱</div><div class="line">email=&quot;xxxx&quot;</div><div class="line">group=$2</div><div class="line"></div><div class="line">if [ -z &quot;$2&quot; ]; then</div><div class="line">	group=&quot;xxx&quot;</div><div class="line">fi</div><div class="line">#执行上传testflight</div><div class="line">pilot upload --verbose --username $&#123;username&#125; --app_identifier $&#123;bundle_id&#125; </div><div class="line">--changelog $&#123;changelog&#125; -d $&#123;beta_app_description&#125; </div><div class="line">--ipa $&#123;ipa_path&#125; --distribute_external $&#123;distribute_external&#125; </div><div class="line">--apple_id $&#123;apple_id&#125; --team_id $&#123;team_id&#125; </div><div class="line">--team_name &quot;$&#123;team_name&#125;&quot; --dev_portal_team_id $&#123;dev_portal_team_id&#125; </div><div class="line">--itc_provider &quot;$&#123;itc_provider&#125;&quot; --beta_app_feedback_email &quot;$&#123;email&#125;&quot; | exit</div><div class="line"></div><div class="line">#输出总用时</div><div class="line">echo &quot;===Finished. Total time: $&#123;SECONDS&#125;s===&quot;</div></pre></td></tr></table></figure>
<p>脚本中的例如team_id等这些值，对于开发或者测试来说应该都不陌生，虽然脚本简单，但是能方便的上传TestFlight，并且分发外部测试，真的非常方便。</p>
<h5 id="2、结果展示"><a href="#2、结果展示" class="headerlink" title="2、结果展示"></a>2、结果展示</h5><p>最后集成到jenkins，可以看到结果：<br><img src="https://raw.githubusercontent.com/diaojunxian/diaojunxian.github.io/master/images/fastlane01.png" alt="推送TestFlight"><br>看到箭头指示的出现，代表已经成功的分发测试，可以去Testflight app下载安装新版本了。</p>
<h3 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h3><p>持续集成工作的开展不是一蹴而就的，iOS打包集成涉及到各种证书环节，需要仔细理清。</p>
<h3 id="七、相关文档"><a href="#七、相关文档" class="headerlink" title="七、相关文档"></a>七、相关文档</h3><ul>
<li><p><a href="https://github.com/KrauseFx/fastlane/tree/master/docs" target="_blank" rel="external">fastlane</a>:<a href="https://github.com/KrauseFx/fastlane/tree/master/docs" target="_blank" rel="external">https://github.com/KrauseFx/fastlane/tree/master/docs</a></p>
</li>
<li><p><a href="https://api.slack" target="_blank" rel="external">slack</a>:<a href="https://api.slack.com/methods" target="_blank" rel="external">https://api.slack.com/methods</a></p>
</li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2017/01/20/持续集成实施-十七-——Fastlane总结/" data-id="ciy6u5d5f0011sqgq7y2ptu7a" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2017/01/21/持续集成-十八-——Samba搭建/" class="pre">持续集成(十八)——Samba搭建</a><a href="/2017/01/18/持续集成实施-十六-——Whistle抓包/" class="next">持续集成实施(十六)——Whistle抓包</a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://yoursite.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/01/21/持续集成-十八-——Samba搭建/">持续集成(十八)——Samba搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/20/持续集成实施-十七-——Fastlane总结/">持续集成实施(十七)——Fastlane总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/18/持续集成实施-十六-——Whistle抓包/">持续集成实施(十六)——Whistle抓包</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/03/Flask部署/">Flask部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/03/Flask-API-序列化和反序列化/">Flask API 序列化和反序列化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/22/持续集成实施-十五-——BlueOcean/">持续集成实施(十五)——BlueOcean</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/12/持续集成实施-十四-——Xcode-Server配置-二/">持续集成实施(十四)——Xcode Server配置(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/09/持续集成实施-十三-——Infer/">持续集成实施(十三)——Infer</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/01/持续集成实施-十二-——Xcode-Server配置/">持续集成实施(十二)——Xcode Server配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/28/持续集成实施-十一-——新需求/">持续集成实施(十一)——新需求</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/diaojunxian/ios_testing" title="Python封装——TuneupJs" target="_blank">Python封装——TuneupJs</a><ul></ul><a href="https://testerhome.com/" title="Testerhome" target="_blank">Testerhome</a><ul></ul><a href="http://www.v2ex.com/" title="V2EX" target="_blank">V2EX</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">自动化测试.</a> Powered by<a rel="nofollow" target="_blank"> DJX.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?true";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>